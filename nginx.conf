user  nginx;
worker_processes  auto;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Sensible static defaults
  sendfile           on;
  tcp_nopush         on;
  tcp_nodelay        on;
  keepalive_timeout  65;

  # Gzip for text/json (safe for Addressables catalogs)
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_types
      text/plain
      text/css
      application/json
      application/javascript
      application/xml
      application/wasm
      application/octet-stream;
  gzip_vary on;

  # Extra MIME types Unity Addressables often need
  types {
    application/wasm                 wasm;
    application/json                 json;
    application/octet-stream         bundle;
    application/octet-stream         hash;
    application/octet-stream         data;
    application/octet-stream         bytes;
    application/octet-stream         ress;
    application/octet-stream         resource;
    application/manifest+json        webmanifest;
    application/font-woff2           woff2;
  }

  # CORS helper (Addressables often load cross-origin)
  map $request_method $cors_preflight {
    default 0;
    "OPTIONS" 1;
  }

  server {
    listen 80 default_server;
    server_name _;

    # Root of the site â€” serves /public/*
    root /usr/share/nginx/html;

    # ---- Health & index ----
    location = / {
      add_header Content-Type text/html;
      return 200 '<!doctype html><html><head><meta charset="utf-8"><title>SV Extract CDN</title></head><body><h1>SV Extract CDN</h1><p>OK</p></body></html>';
    }

    location = /healthz {
      default_type text/plain;
      return 200 'ok';
    }

    # ---- Addressables ----
    # Unity Addressables live under /addressables/<BuildTarget>/
    location /addressables/ {

      # CORS: allow Unity client to fetch from a different domain
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Range" always;
      add_header Access-Control-Expose-Headers "Content-Length, Accept-Ranges, Content-Range" always;

      # Preflight handling
      if ($cors_preflight) {
        return 204;
      }

      # Cache policy:
      # - .bundle / .data / .wasm / .bytes / .ress / .resource: immutable, 1 year
      # - .json (catalog), .hash: short cache so clients get updates quickly
      # - default: moderate cache for other static files

      location ~* \.(bundle|data|wasm|bytes|ress|resource|br|gz)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
      }

      location ~* \.(json|hash)$ {
        add_header Cache-Control "public, max-age=60, must-revalidate";
        try_files $uri =404;
      }

      # fallback/default for icons/images/etc.
      location / {
        add_header Cache-Control "public, max-age=86400";
        try_files $uri =404;
      }
    }

    # Disable directory listing
    autoindex off;

    # Light security headers
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
  }
}
